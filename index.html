<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EnergiaCorp - OCR & Documenti Cloud</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@v5.0.5/dist/tesseract.min.js"></script>
  <style>
    /* minimal styles focusing on mobile scrolling fix */
    body{font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif;margin:0;background:#f8fafc;color:#1e293b}
    header{padding:1rem;background:#06b6d4;color:#fff;display:flex;justify-content:space-between}
    .wrapper{padding:1rem}
    .table-wrapper{overflow:auto max-height:70vh;-webkit-overflow-scrolling:touch}
    table{border-collapse:collapse;width:100%;min-width:750px}
    th,td{padding:.75rem;border-bottom:1px solid #e2e8f0}
    th{background:#3b82f6;color:#fff;position:sticky;top:0}
    #ocr-status{margin:1rem 0}
  </style>
</head>
<body>
  <header>
    <strong>EnergiaCorp Cloud</strong>
    <div id="user-area"></div>
  </header>
  <div class="wrapper">

    <!-- Auth -->
    <div id="auth-area">
      <h2>Login / Register</h2>
      <input id="auth-email" placeholder="Email" type="email"><br>
      <input id="auth-password" placeholder="Password" type="password"><br>
      <button onclick="login()">Login</button>
      <button onclick="register()">Register</button>
      <p id="auth-msg" style="color:#dc2626"></p>
    </div>

    <!-- OCR upload -->
    <div id="ocr-area" style="display:none">
      <h2>OCR Upload</h2>
      <input type="file" id="ocr-file" accept="image/*,application/pdf"><br>
      <progress id="ocr-progress" value="0" max="100"></progress>
      <p id="ocr-status"></p>
      <textarea id="ocr-text" rows="6" style="width:100%"></textarea>
    </div>

    <!-- Document upload -->
    <div id="doc-area" style="display:none">
      <h2>Carica Documento</h2>
      <input id="client-name" placeholder="Nome cliente"><br>
      <input type="file" id="doc-file"><br>
      <button onclick="uploadDoc()">Upload</button>
      <p id="doc-msg"></p>
    </div>

    <!-- Table offers scrollable on mobile -->
    <div class="table-wrapper" id="offers-wrapper" style="display:none">
      <table id="offers-table">
        <thead><tr><th>Fornitore</th><th>Offerta</th><th>Prezzo</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const SUPABASE_URL = 'https://ozmqftibxuspznnqaayh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96bXFmdGlieHVzcHpubnFhYXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDUwNTQsImV4cCI6MjA3MjIyMTA1NH0._Z8pGoW_Yc6PiazF-6jxwVknmJ9vh4WLotN6bPRK1Kk';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
let worker;

initOCR();

async function initOCR(){
  worker = await Tesseract.createWorker('ita+eng');
}

async function login(){
  const email=document.getElementById('auth-email').value;
  const password=document.getElementById('auth-password').value;
  const {data,error}=await supabase.auth.signInWithPassword({email,password});
  if(error)return showAuthMsg(error.message);
  afterLogin(data.user);
}

async function register(){
  const email=document.getElementById('auth-email').value;
  const password=document.getElementById('auth-password').value;
  const {data,error}=await supabase.auth.signUp({email,password});
  if(error)return showAuthMsg(error.message);
  showAuthMsg('Controlla la mail di conferma per attivare l\'account');
}

function showAuthMsg(msg){document.getElementById('auth-msg').textContent=msg;}

function afterLogin(user){
  document.getElementById('auth-area').style.display='none';
  document.getElementById('user-area').textContent=user.email;
  document.getElementById('ocr-area').style.display='block';
  document.getElementById('doc-area').style.display='block';
  document.getElementById('offers-wrapper').style.display='block';
  loadOffers();
}

// OCR handler
 document.getElementById('ocr-file').addEventListener('change',async(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  document.getElementById('ocr-progress').value=0;
  const {data:{text}}=await worker.recognize(file,{logger:m=>{
    if(m.status==='recognizing text')document.getElementById('ocr-progress').value=Math.round(m.progress*100);
  }});
  document.getElementById('ocr-text').value=text;
  document.getElementById('ocr-status').textContent='OCR completato';
 });

// Upload document and metadata to Supabase
async function uploadDoc(){
  const fileEl=document.getElementById('doc-file');
  const client=document.getElementById('client-name').value;
  if(!fileEl.files.length||!client)return alert('Dati mancanti');
  const file=fileEl.files[0];
  const user=supabase.auth.getUser();
  const path=`documents/${user.data.user.id}/${Date.now()}_${file.name}`;
  const {error:upErr}=await supabase.storage.from('client-documents').upload(path,file);
  if(upErr)return showDocMsg(upErr.message);
  const {error:dbErr}=await supabase.from('client_documents').insert({
    user_id:user.data.user.id,
    client_name:client,
    document_type:'Generale',
    filename:file.name,
    original_filename:file.name,
    file_size:file.size,
    mime_type:file.type,
    storage_path:path,
    created_at:new Date().toISOString()
  });
  if(dbErr)return showDocMsg(dbErr.message);
  showDocMsg('Documento salvato');
}
function showDocMsg(msg){document.getElementById('doc-msg').textContent=msg;}

// Load offers list
async function loadOffers(){
 const {data,error}=await supabase.from('offers').select('*').limit(50);
 if(error)return;
 const tbody=document.querySelector('#offers-table tbody');
 tbody.innerHTML='';
 data.forEach(o=>{
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${o.fornitore}</td><td>${o.nome_offerta}</td><td>${o.prezzo_luce||o.prezzo_gas||''}</td>`;
  tbody.appendChild(tr);
 });
}
</script>
</body>
</html>
