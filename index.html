<script>
// Landing Page Logic + Email Confirmation Handling
document.addEventListener('DOMContentLoaded', async function() {
    let isSignupMode = false;
    
    // CHECK EMAIL CONFIRMATION ON PAGE LOAD
    const urlParams = new URLSearchParams(window.location.search);
    const urlHash = window.location.hash;
    
    // Gestione conferma email
    if (urlParams.get('type') === 'signup' || urlHash.includes('access_token') || urlParams.get('token_hash')) {
        console.log('Email confirmation detected');
        
        // Mostra loading
        document.body.innerHTML = `
            <div style="
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                font-family: Inter, sans-serif;
                text-align: center;
            ">
                <div>
                    <div style="
                        width: 80px;
                        height: 80px;
                        border: 4px solid rgba(255,255,255,0.3);
                        border-top: 4px solid white;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 2rem;
                    "></div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Conferma Email in Corso...</h2>
                    <p style="opacity: 0.9;">Stiamo verificando la tua email, attendi un momento.</p>
                </div>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        `;
        
        try {
            // Aspetta un momento per far processare il token
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Controlla se l'utente √® ora autenticato
            const user = await getCurrentUser();
            
            if (user) {
                // Success! Redirect alla app
                alert('‚úÖ Email confermata con successo! Benvenuto in EnergiaCorp Premium.');
                
                // Ricarica la pagina senza i parametri URL
                const baseUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, baseUrl);
                window.location.reload();
            } else {
                // Errore nella conferma
                alert('‚ùå Errore nella conferma email. Riprova o contatta il supporto.');
                window.location.href = window.location.origin + window.location.pathname;
            }
            
        } catch (error) {
            console.error('Email confirmation error:', error);
            alert('‚ùå Errore nella conferma email: ' + error.message);
            window.location.href = window.location.origin + window.location.pathname;
        }
        
        return; // Ferma l'esecuzione del resto del codice
    }
    
    // CONTROLLO SE GIA' LOGGATO
    try {
        const currentUser = await getCurrentUser();
        if (currentUser) {
            // Utente gi√† loggato - vai direttamente all'app
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            const userName = document.getElementById('user-name');
            if (userName && currentUser.user_metadata?.full_name) {
                userName.textContent = 'Ciao, ' + currentUser.user_metadata.full_name;
            }
            
            if (typeof initializeApp === 'function') {
                await initializeApp();
            }
            return;
        }
    } catch (error) {
        console.log('No user logged in, showing landing page');
    }
    
    // RESTO DEL CODICE LANDING PAGE
    const loginTab = document.getElementById('login-tab');
    const signupTab = document.getElementById('signup-tab');
    const signupFields = document.getElementById('signup-fields');
    const authTitle = document.getElementById('auth-title');
    const authSubmitText = document.getElementById('auth-submit-text');
    const authFooterText = document.getElementById('auth-footer-text');
    
    // Tab switching
    loginTab.addEventListener('click', () => switchToLogin());
    signupTab.addEventListener('click', () => switchToSignup());
    
    function switchToLogin() {
        isSignupMode = false;
        loginTab.classList.add('active');
        signupTab.classList.remove('active');
        signupFields.style.display = 'none';
        authTitle.textContent = 'Accedi alla Piattaforma';
        authSubmitText.textContent = 'Accedi alla Dashboard';
        authFooterText.textContent = 'Accedendo accetti i nostri termini di servizio e la privacy policy';
    }
    
    function switchToSignup() {
        isSignupMode = true;
        signupTab.classList.add('active');
        loginTab.classList.remove('active');
        signupFields.style.display = 'block';
        authTitle.textContent = 'Crea il Tuo Account';
        authSubmitText.textContent = 'Crea Account e Accedi';
        authFooterText.textContent = 'Registrandoti accetti i nostri termini di servizio e la privacy policy';
    }
    
    // Auth form handling
    const authForm = document.getElementById('auth-form');
    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = document.getElementById('auth-submit');
        const originalText = authSubmitText.textContent;
        
        try {
            submitBtn.disabled = true;
            authSubmitText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Caricamento...</span>';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            let result;
            
            if (isSignupMode) {
                const fullName = document.getElementById('full-name').value;
                result = await signUp(email, password, fullName);
                
                if (!result.error) {
                    alert('üìß Registrazione completata! Controlla la tua email per confermare, poi potrai accedere.');
                    switchToLogin();
                    document.getElementById('email').value = email; // Pre-compila email
                    return;
                }
            } else {
                result = await signIn(email, password);
                
                if (!result.error) {
                    // Success - Hide landing page and show app
                    document.getElementById('landing-page').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    
                    const userName = document.getElementById('user-name');
                    if (userName && result.data.user.user_metadata?.full_name) {
                        userName.textContent = 'Ciao, ' + result.data.user.user_metadata.full_name;
                    }
                    
                    if (typeof initializeApp === 'function') {
                        await initializeApp();
                    }
                    return;
                }
            }
            
            alert('‚ùå Errore: ' + result.error.message);
            
        } catch (error) {
            alert('‚ùå Errore: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            authSubmitText.textContent = originalText;
        }
    });
});
</script>
