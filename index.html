import React, { useEffect, useMemo, useRef, useState } from "react";
import { Upload, FileText, Filter, Settings, Building2, Save, X, Search, RefreshCw, Download } from "lucide-react";
import * as pdfjsLib from "pdfjs-dist/legacy/build/pdf";
import Tesseract from "tesseract.js";
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from "recharts";

/**
 * CTE Energia & Gas — MVP Single-File React App
 * Funzioni principali:
 * - Upload PDF con estrazione testo (pdf.js); fallback OCR (Tesseract.js) per PDF scansionati
 * - Parsing campi: spread, costo fisso, scadenza, commissioni, categoria (PMI/Micro/Domestico), fornitore/azienda
 * - Catalogazione per azienda e categoria
 * - Stima costo mensile (consumi configurabili per categoria)
 * - Dashboard: KPI, migliori offerte per categoria, tabella filtrabile/ordinabile, grafico distribuzione spread
 * - Persistenza locale (localStorage) + import/export JSON
 * NOTE: questo è un MVP client‑side. Per molti PDF reali potresti voler rifinire i regex e le mappe sinonimi.
 */

// ---- Tipi ----
/** @typedef {"PMI"|"Micro"|"Domestico"} Categoria */

// Mappa consumi predefiniti (kWh/mese)
const DEFAULT_CONSUMO = {
  PMI: 2000,
  Micro: 800,
  Domestico: 200,
};

// Alcune aziende note (arricchisci liberamente)
const KNOWN_COMPANIES = [
  "Enel", "Enel Energia", "Eni Plenitude", "Sorgenia", "Iren", "Edison", "A2A", "Acea",
  "Italpower", "Sinergy Direct", "Segno Verde", "Villani", "Consulenza Utenze",
];

// ---- Utils ----
const fmtNumber = (n, d=2) => {
  if (n === null || n === undefined || isNaN(n)) return "—";
  return n.toLocaleString("it-IT", { minimumFractionDigits: d, maximumFractionDigits: d });
};
const daysBetween = (a, b) => Math.ceil((a.getTime() - b.getTime()) / (1000*60*60*24));
const toDate = (s) => {
  // prova vari formati DD/MM/YYYY, DD-MM-YYYY, YYYY-MM-DD
  if (!s) return null;
  const m1 = s.match(/(\d{1,2})[\/\.-](\d{1,2})[\/\.-](\d{2,4})/);
  if (m1) {
    const d = parseInt(m1[1],10), mo=parseInt(m1[2],10)-1, y=parseInt(m1[3].length===2?"20"+m1[3]:m1[3],10);
    const dt = new Date(y, mo, d);
    return isNaN(dt.getTime()) ? null : dt;
  }
  const m2 = s.match(/(20\d{2})[\/-](\d{1,2})[\/-](\d{1,2})/);
  if (m2) {
    const y=parseInt(m2[1],10), mo=parseInt(m2[2],10)-1, d=parseInt(m2[3],10);
    const dt = new Date(y, mo, d);
    return isNaN(dt.getTime()) ? null : dt;
  }
  return null;
};

// Normalizza spread verso €/kWh
function normalizeSpread(value, unitGuess) {
  if (value == null || isNaN(value)) return { eurkwh: null, unit: unitGuess || "€/kWh" };
  const u = (unitGuess||"").toLowerCase();
  if (u.includes("cent") || u.includes("c€/kwh") || u.includes("c/")) {
    return { eurkwh: value/100, unit: "€/kWh" };
  }
  if (u.includes("%")) {
    // Percentuale su PUN/PSV: impossibile normalizzare senza base -> lasciamo null per ranking
    return { eurkwh: null, unit: "% (su indice)" };
  }
  // di default assumiamo €/kWh
  return { eurkwh: value, unit: "€/kWh" };
}

// Stima costo mensile = spread(€/kWh)*consumo + costo fisso (€)
function estimatedMonthly(spreadEurKwh, fixedEuro, consumo) {
  if (spreadEurKwh == null || isNaN(spreadEurKwh)) return null;
  const fx = (fixedEuro || 0);
  return spreadEurKwh * (consumo||0) + fx;
}

// Estrai prima occorrenza numerica
const firstNumber = (s) => {
  if (!s) return null;
  const m = s.replace(",",".").match(/-?\d+(?:[\.,]\d+)?/);
  return m ? parseFloat(m[0].replace(",",".")) : null;
};

function guessCompany(text) {
  for (const c of KNOWN_COMPANIES) {
    const r = new RegExp(`(^|[^A-Z])${c.replace(/[-/\\^$*+?.()|[\]{}]/g, "\\$&")}([^A-Z]|$)`, "i");
    if (r.test(text)) return c;
  }
  // fallback: cerca parole dopo "Fornitore" o "Azienda"
  const m = text.match(/(?:Fornitore|Azienda|Società)\s*[:\-]?\s*([A-Z][A-Za-z0-9 &\-]{2,})/i);
  return m ? m[1].trim() : "Sconosciuta";
}

function guessCategoria(text) {
  if (/\bPMI\b/i.test(text)) return "PMI";
  if (/\bMicro\b/i.test(text)) return "Micro";
  if (/(Domestico|Residenziale|Famiglia)/i.test(text)) return "Domestico";
  return "Domestico"; // default conservativo
}

function parseFields(text) {
  const lower = text.toLowerCase();
  // SPREAD
  const spreadMatch = text.match(/\bspread\b[\s:*\-–]*([^\n\r]+)/i) || text.match(/\b(margine|mark\s?up)\b[\s:*\-–]*([^\n\r]+)/i);
  let spreadRaw = spreadMatch ? spreadMatch[1] : null;
  let spreadVal = firstNumber(spreadRaw);
  let spreadUnit = spreadRaw ? (spreadRaw.includes("c")?"c€/kWh": (spreadRaw.includes("%")?"%":"€/kWh")) : "€/kWh";

  // COSTO FISSO
  const fixedMatch = text.match(/(costi?\s*fissi?|quota\s*fissa|pcv|qvd)\s*[:*\-–]?\s*([^\n\r]+)/i);
  let fixedRaw = fixedMatch ? fixedMatch[2] : null;
  let fixedVal = firstNumber(fixedRaw);

  // COMMISSIONI
  const commMatch = text.match(/commissioni?(?:\s*(?:agente|broker))?\s*[:*\-–]?\s*([^\n\r]+)/i);
  let commRaw = commMatch ? commMatch[1] : null;
  let commVal = firstNumber(commRaw);
  let commUnit = commRaw ? (/%/.test(commRaw)?"%":"€") : "€";

  // SCADENZA
  const scadMatch = text.match(/(scadenza|validità|decorrenza)\s*[:*\-–]?\s*([^\n\r]+)/i);
  const scadRaw = scadMatch ? scadMatch[2] : null;
  const expiry = toDate(scadRaw);

  const company = guessCompany(text);
  const category = guessCategoria(text);

  return {
    spreadVal, spreadUnit,
    fixedVal,
    commVal, commUnit,
    expiry,
    company,
    category,
  };
}

// ---- Persistenza ----
const STORAGE_KEY = "cte_offers_v1";
const SETTINGS_KEY = "cte_settings_v1";

function loadOffers() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); } catch { return []; }
}
function saveOffers(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}
function loadSettings() {
  try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)||"null") || { consumo: DEFAULT_CONSUMO }; } catch { return { consumo: DEFAULT_CONSUMO }; }
}
function saveSettings(s) { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

// ---- PDF & OCR ----
async function extractTextFromPdf(file, onProgress) {
  // Prova textContent via pdf.js; se troppo corto, tenta OCR con Tesseract
  pdfjsLib.GlobalWorkerOptions.workerSrc = null; // disabilitiamo il worker
  const loadingTask = pdfjsLib.getDocument({ data: await file.arrayBuffer(), disableWorker: true, isEvalSupported: false });
  const pdf = await loadingTask.promise;
  let fullText = "";
  for (let p=1; p<=pdf.numPages; p++) {
    onProgress && onProgress({ phase: "pdfText", page: p, pages: pdf.numPages });
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const pageText = content.items.map(it => it.str).join(" ");
    fullText += "\n" + pageText;
  }
  const cleaned = fullText.replace(/\s+/g, " ").trim();
  if (cleaned.length > 100) return cleaned;

  // fallback OCR: rasterizza pagine a canvas e riconosci
  let ocrText = "";
  for (let p=1; p<=pdf.numPages; p++) {
    onProgress && onProgress({ phase: "ocr", page: p, pages: pdf.numPages });
    const page = await pdf.getPage(p);
    const viewport = page.getViewport({ scale: 1.5 });
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = viewport.width; canvas.height = viewport.height;
    await page.render({ canvasContext: ctx, viewport }).promise;
    const dataUrl = canvas.toDataURL();
    const res = await Tesseract.recognize(dataUrl, "ita+eng", { logger: (m) => onProgress && onProgress({ phase: "ocrProgress", message: m.status }) });
    ocrText += "\n" + res.data.text;
  }
  return ocrText.replace(/\s+/g, " ").trim();
}

// ---- Componenti UI ----
function Stat({ label, value, sub }) {
  return (
    <div className="rounded-2xl p-4 shadow bg-white border">
      <div className="text-sm text-gray-500">{label}</div>
      <div className="text-2xl font-semibold">{value}</div>
      {sub && <div className="text-xs text-gray-400 mt-1">{sub}</div>}
    </div>
  );
}

function Badge({ children, tone="slate" }) {
  return <span className={`px-2 py-0.5 rounded-full text-xs border bg-${tone}-50 border-${tone}-200 text-${tone}-700`}>{children}</span>;
}

function Modal({ open, onClose, title, children, actions }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="relative bg-white rounded-2xl p-6 w-full max-w-2xl shadow-xl">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">{title}</h3>
          <button onClick={onClose} className="p-2 rounded hover:bg-gray-100"><X size={18}/></button>
        </div>
        <div className="max-h-[60vh] overflow-auto pr-1">{children}</div>
        {actions && <div className="mt-4 flex gap-2 justify-end">{actions}</div>}
      </div>
    </div>
  );
}

export default function App() {
  const [offers, setOffers] = useState(() => loadOffers());
  const [query, setQuery] = useState("");
  const [companyFilter, setCompanyFilter] = useState("Tutte");
  const [categoryFilter, setCategoryFilter] = useState(/** @type {Categoria|"Tutte"} */("Tutte"));
  const [sortBy, setSortBy] = useState("costo");
  const [sortDir, setSortDir] = useState("asc");
  const [settings, setSettings] = useState(() => loadSettings());
  const [showSettings, setShowSettings] = useState(false);
  const [editing, setEditing] = useState(null); // offerta in modifica
  const [progress, setProgress] = useState(null);

  useEffect(() => { saveOffers(offers); }, [offers]);
  useEffect(() => { saveSettings(settings); }, [settings]);

  const companies = useMemo(() => {
    const s = new Set(); offers.forEach(o => s.add(o.company||"Sconosciuta"));
    return ["Tutte", ...Array.from(s).sort()];
  }, [offers]);

  const filtered = useMemo(() => {
    const q = query.trim().toLowerCase();
    const out = offers.filter(o => {
      let ok = true;
      if (companyFilter !== "Tutte") ok = ok && o.company === companyFilter;
      if (categoryFilter !== "Tutte") ok = ok && o.category === categoryFilter;
      if (q) ok = ok && (
        (o.company||"").toLowerCase().includes(q) ||
        (o.source||"").toLowerCase().includes(q) ||
        (o.notes||"").toLowerCase().includes(q)
      );
      return ok;
    });
    const sorted = [...out].sort((a,b) => {
      const dir = sortDir === "asc" ? 1 : -1;
      if (sortBy === "costo") return dir * ((a.estimated||Infinity) - (b.estimated||Infinity));
      if (sortBy === "spread") return dir * ((a.spreadEurKwh??Infinity) - (b.spreadEurKwh??Infinity));
      if (sortBy === "fisso") return dir * ((a.fixedVal??Infinity) - (b.fixedVal??Infinity));
      if (sortBy === "scadenza") {
        const ad = a.expiry ? a.expiry : new Date(8640000000000000);
        const bd = b.expiry ? b.expiry : new Date(8640000000000000);
        return dir * (ad - bd);
      }
      return 0;
    });
    return sorted;
  }, [offers, query, companyFilter, categoryFilter, sortBy, sortDir]);

  const kpi = useMemo(() => {
    const now = new Date();
    const spreads = offers.map(o => o.spreadEurKwh).filter(v => v!=null && !isNaN(v));
    const avgSpread = spreads.length ? spreads.reduce((a,b)=>a+b,0)/spreads.length : null;
    const fixeds = offers.map(o => o.fixedVal).filter(v => v!=null && !isNaN(v));
    const avgFixed = fixeds.length ? fixeds.reduce((a,b)=>a+b,0)/fixeds.length : null;
    const expiring = offers.filter(o => o.expiry && daysBetween(o.expiry, now) <= 30).length;
    return { avgSpread, avgFixed, expiring };
  }, [offers]);

  const bestByCat = useMemo(() => {
    /** @type {Record<Categoria, any>} */
    const res = { PMI: null, Micro: null, Domestico: null };
    const cats = ["PMI","Micro","Domestico"];
    for (const c of cats) {
      const subset = offers.filter(o => o.category===c && o.estimated!=null).sort((a,b)=>a.estimated-b.estimated);
      res[c] = subset[0] || null;
    }
    return res;
  }, [offers]);

  // ---- Handlers ----
  async function handleFiles(files) {
    for (const file of files) {
      setProgress({ file: file.name, phase: "lettura" });
      const text = await extractTextFromPdf(file, (p) => setProgress({ file: file.name, ...p }));
      const fields = parseFields(text);
      const norm = normalizeSpread(fields.spreadVal, fields.spreadUnit);
      const consumo = settings.consumo[fields.category] || DEFAULT_CONSUMO[fields.category];
      const estimated = estimatedMonthly(norm.eurkwh, fields.fixedVal, consumo);
      const offer = {
        id: `${Date.now()}_${Math.random().toString(36).slice(2)}`,
        source: file.name,
        rawText: text,
        company: fields.company,
        category: fields.category,
        spreadVal: fields.spreadVal,
        spreadUnit: fields.spreadUnit,
        spreadEurKwh: norm.eurkwh,
        fixedVal: fields.fixedVal,
        commVal: fields.commVal,
        commUnit: fields.commUnit,
        expiry: fields.expiry,
        estimated,
        createdAt: new Date().toISOString(),
      };
      setOffers(prev => [offer, ...prev]);
      setEditing(offer);
      setProgress(null);
    }
  }

  function updateOffer(patch) {
    setOffers(prev => prev.map(o => o.id===patch.id ? { ...o, ...patch } : o));
  }
  function deleteOffer(id) { setOffers(prev => prev.filter(o => o.id!==id)); }

  function exportJSON() {
    const blob = new Blob([JSON.stringify(offers, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "offerte_cte.json"; a.click();
    URL.revokeObjectURL(url);
  }
  function importJSON(file) {
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(r.result);
        if (Array.isArray(data)) setOffers(data.map(o => ({ ...o, expiry: o.expiry? new Date(o.expiry): null })));
      } catch {}
    };
    r.readAsText(file);
  }

  // ---- Render ----
  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-50 to-white text-slate-900">
      <header className="sticky top-0 z-40 backdrop-blur bg-white/70 border-b">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
          <Building2 className="text-emerald-600"/>
          <h1 className="text-xl sm:text-2xl font-bold">CTE Energia & Gas — Gestione Offerte PDF</h1>
          <div className="ml-auto flex items-center gap-2">
            <button className="btn" onClick={()=>setShowSettings(true)}><Settings size={18} className="inline mr-2"/>Impostazioni</button>
            <button className="btn" onClick={exportJSON}><Download size={18} className="inline mr-2"/>Export</button>
            <label className="btn cursor-pointer">
              <Upload size={18} className="inline mr-2"/>Import
              <input type="file" accept="application/json" className="hidden" onChange={e=> e.target.files && importJSON(e.target.files[0])}/>
            </label>
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Upload */}
        <section className="rounded-2xl border bg-white p-5 shadow">
          <div className="flex items-center justify-between gap-3 flex-wrap">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-xl bg-emerald-50 border border-emerald-200"><FileText className="text-emerald-600"/></div>
              <div>
                <h2 className="text-lg font-semibold">Carica offerte in PDF</h2>
                <p className="text-sm text-gray-500">Il testo viene estratto automaticamente; se necessario si usa l'OCR.</p>
              </div>
            </div>
            <label className="btn cursor-pointer">
              <Upload size={18} className="inline mr-2"/>Seleziona PDF
              <input type="file" accept="application/pdf" multiple className="hidden" onChange={e => e.target.files && handleFiles(e.target.files)} />
            </label>
          </div>
          {progress && (
            <div className="mt-4 text-sm text-gray-600">
              <span className="font-medium">{progress.file}</span>: {progress.phase === "pdfText" && `lettura testo pagina ${progress.page}/${progress.pages}`}
              {progress.phase === "ocr" && `OCR pagina ${progress.page}/${progress.pages}`}
              {progress.phase === "ocrProgress" && `OCR… ${progress.message}`}
            </div>
          )}
        </section>

        {/* KPI */}
        <section className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <Stat label="Offerte totali" value={offers.length} />
          <Stat label="Spread medio (€/kWh)" value={fmtNumber(kpi.avgSpread)} />
          <Stat label="Costo fisso medio (€)" value={fmtNumber(kpi.avgFixed)} />
          <Stat label="In scadenza (≤ 30 gg)" value={kpi.expiring} />
        </section>

        {/* Best per categoria */}
        <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {(["PMI","Micro","Domestico"]).map(cat => {
            const o = bestByCat[cat];
            return (
              <div key={cat} className="rounded-2xl border bg-white p-5 shadow">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-base font-semibold">Migliore {cat}</h3>
                  <Badge tone="emerald">Top</Badge>
                </div>
                {o ? (
                  <div>
                    <div className="text-lg font-semibold">{o.company}</div>
                    <div className="text-sm text-gray-500">{o.source}</div>
                    <div className="mt-2 grid grid-cols-2 gap-2 text-sm">
                      <div className="p-2 rounded-lg bg-slate-50 border">
                        <div className="text-xs text-gray-500">Spread</div>
                        <div className="font-medium">{fmtNumber(o.spreadEurKwh)} €/kWh</div>
                      </div>
                      <div className="p-2 rounded-lg bg-slate-50 border">
                        <div className="text-xs text-gray-500">Fisso</div>
                        <div className="font-medium">{fmtNumber(o.fixedVal)} €</div>
                      </div>
                      <div className="p-2 rounded-lg bg-slate-50 border">
                        <div className="text-xs text-gray-500">Stima mensile</div>
                        <div className="font-medium">{fmtNumber(o.estimated)} €</div>
                      </div>
                      <div className="p-2 rounded-lg bg-slate-50 border">
                        <div className="text-xs text-gray-500">Scadenza</div>
                        <div className="font-medium">{o.expiry? o.expiry.toLocaleDateString("it-IT"): "—"}</div>
                      </div>
                    </div>
                    <div className="mt-3 flex gap-2">
                      <button className="btn" onClick={()=>setEditing(o)}>Modifica</button>
                    </div>
                  </div>
                ) : (
                  <div className="text-sm text-gray-500">Nessuna offerta {cat} ancora caricata.</div>
                )}
              </div>
            );
          })}
        </section>

        {/* Filtri e tabella */}
        <section className="rounded-2xl border bg-white p-5 shadow">
          <div className="flex flex-wrap items-center gap-3 mb-4">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2" size={16}/>
              <input className="input pl-9" placeholder="Cerca per azienda/sorgente…" value={query} onChange={e=>setQuery(e.target.value)} />
            </div>
            <select className="input" value={companyFilter} onChange={e=>setCompanyFilter(e.target.value)}>
              {companies.map(c => <option key={c}>{c}</option>)}
            </select>
            <select className="input" value={categoryFilter} onChange={e=>setCategoryFilter(e.target.value)}>
              {(["Tutte","PMI","Micro","Domestico"]).map(c => <option key={c}>{c}</option>)}
            </select>
            <div className="ml-auto flex gap-2 items-center">
              <label className="btn cursor-pointer">
                <Upload size={16} className="mr-2"/>Aggiungi PDF
                <input type="file" multiple accept="application/pdf" className="hidden" onChange={e => e.target.files && handleFiles(e.target.files)} />
              </label>
              <button className="btn" onClick={()=>{ setSortBy("costo"); setSortDir(sortDir==="asc"?"desc":"asc"); }}><Filter size={16} className="mr-2"/>Ordina per costo ({sortDir})</button>
            </div>
          </div>

          <div className="overflow-auto">
            <table className="w-full text-sm">
              <thead className="text-left sticky top-0 bg-white">
                <tr className="border-b">
                  <th className="py-2 pr-2">Azienda</th>
                  <th className="py-2 pr-2">Categoria</th>
                  <th className="py-2 pr-2 cursor-pointer" onClick={()=>{ setSortBy("spread"); setSortDir(sortDir==="asc"?"desc":"asc"); }}>Spread (€/kWh)</th>
                  <th className="py-2 pr-2 cursor-pointer" onClick={()=>{ setSortBy("fisso"); setSortDir(sortDir==="asc"?"desc":"asc"); }}>Fisso (€)</th>
                  <th className="py-2 pr-2">Stima mensile (€)</th>
                  <th className="py-2 pr-2 cursor-pointer" onClick={()=>{ setSortBy("scadenza"); setSortDir(sortDir==="asc"?"desc":"asc"); }}>Scadenza</th>
                  <th className="py-2 pr-2">PDF</th>
                  <th className="py-2 pr-2">Azioni</th>
                </tr>
              </thead>
              <tbody>
                {filtered.map(o => (
                  <tr key={o.id} className="border-b hover:bg-slate-50">
                    <td className="py-2 pr-2 font-medium">{o.company}</td>
                    <td className="py-2 pr-2"><Badge>{o.category}</Badge></td>
                    <td className="py-2 pr-2">{fmtNumber(o.spreadEurKwh)}</td>
                    <td className="py-2 pr-2">{fmtNumber(o.fixedVal)}</td>
                    <td className="py-2 pr-2 font-semibold">{fmtNumber(o.estimated)}</td>
                    <td className="py-2 pr-2">{o.expiry? o.expiry.toLocaleDateString("it-IT"): "—"}</td>
                    <td className="py-2 pr-2">{o.source}</td>
                    <td className="py-2 pr-2 flex gap-2">
                      <button className="btn" onClick={()=>setEditing(o)}>Modifica</button>
                      <button className="btn btn-danger" onClick={()=>deleteOffer(o.id)}>Elimina</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>

        {/* Chart distribuzione spread */}
        <section className="rounded-2xl border bg-white p-5 shadow">
          <div className="mb-3 flex items-center gap-2"><Filter size={16}/><h3 className="font-semibold">Distribuzione spread (€/kWh)</h3></div>
          <ResponsiveContainer width="100%" height={280}>
            <BarChart data={offers.filter(o=>o.spreadEurKwh!=null).map(o=>({ name: o.company.slice(0,12), value: o.spreadEurKwh }))}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis />
              <Tooltip />
              <Bar dataKey="value" />
            </BarChart>
          </ResponsiveContainer>
        </section>

        <footer className="text-center text-xs text-gray-400 py-6">MVP locale — perfeziona regex, categorie e ranking in base ai tuoi PDF reali.</footer>
      </main>

      {/* MODAL Impostazioni */}
      <Modal open={showSettings} onClose={()=>setShowSettings(false)} title="Impostazioni & Assunzioni">
        <div className="space-y-4">
          <div>
            <div className="font-medium mb-1">Consumi stimati (kWh/mese)</div>
            {(["PMI","Micro","Domestico"]).map(cat => (
              <div key={cat} className="flex items-center gap-3 mb-2">
                <div className="w-28">{cat}</div>
                <input type="number" className="input" value={settings.consumo[cat]} onChange={e=> setSettings(s=> ({...s, consumo: { ...s.consumo, [cat]: parseFloat(e.target.value)||0 } }))} />
              </div>
            ))}
            <p className="text-xs text-gray-500">Usati per calcolare la <span className="font-medium">stima costo mensile</span> = spread €/kWh × consumo + fisso €.</p>
          </div>
        </div>
        <div className="mt-4 flex justify-end gap-2">
          <button className="btn" onClick={()=>setShowSettings(false)}><Save size={16} className="mr-2"/>Salva</button>
        </div>
      </Modal>

      {/* MODAL Modifica offerta */}
      <Modal open={!!editing} onClose={()=>setEditing(null)} title="Rivedi & Modifica offerta" actions={[
        <button key="save" className="btn" onClick={()=>setEditing(null)}><Save size={16} className="mr-2"/>Chiudi</button>
      ]}>
        {editing && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label className="label">Azienda</label>
              <input className="input" value={editing.company||""} onChange={e=>updateOffer({ id: editing.id, company: e.target.value })} />
            </div>
            <div>
              <label className="label">Categoria</label>
              <select className="input" value={editing.category} onChange={e=>{
                const category=e.target.value; const consumo = settings.consumo[category]||DEFAULT_CONSUMO[category];
                const estimated = estimatedMonthly(editing.spreadEurKwh, editing.fixedVal, consumo);
                updateOffer({ id: editing.id, category, estimated });
              }}>
                {(["PMI","Micro","Domestico"]).map(c => <option key={c}>{c}</option>)}
              </select>
            </div>
            <div>
              <label className="label">Spread (valore)</label>
              <input type="number" step="0.0001" className="input" value={editing.spreadEurKwh ?? ""}
                     onChange={e=>{
                       const spreadEurKwh = e.target.value===""? null : parseFloat(e.target.value);
                       const consumo = settings.consumo[editing.category]||DEFAULT_CONSUMO[editing.category];
                       const estimated = estimatedMonthly(spreadEurKwh, editing.fixedVal, consumo);
                       updateOffer({ id: editing.id, spreadEurKwh, estimated });
                     }} />
              <p className="text-xs text-gray-500">Inserisci in €/kWh. Se sul PDF è in c€/kWh, dividi per 100.</p>
            </div>
            <div>
              <label className="label">Costo fisso (€)</label>
              <input type="number" step="0.01" className="input" value={editing.fixedVal ?? ""}
                     onChange={e=>{
                       const fixedVal = e.target.value===""? null : parseFloat(e.target.value);
                       const consumo = settings.consumo[editing.category]||DEFAULT_CONSUMO[editing.category];
                       const estimated = estimatedMonthly(editing.spreadEurKwh, fixedVal, consumo);
                       updateOffer({ id: editing.id, fixedVal, estimated });
                     }} />
            </div>
            <div>
              <label className="label">Commissioni ({editing.commUnit||"€"})</label>
              <input type="number" step="0.01" className="input" value={editing.commVal ?? ""} onChange={e=>updateOffer({ id: editing.id, commVal: e.target.value===""? null : parseFloat(e.target.value) })} />
            </div>
            <div>
              <label className="label">Scadenza</label>
              <input type="date" className="input" value={editing.expiry? new Date(editing.expiry).toISOString().slice(0,10) : ""}
                     onChange={e=>updateOffer({ id: editing.id, expiry: e.target.value? new Date(e.target.value): null })} />
            </div>
            <div className="md:col-span-2">
              <label className="label">Note</label>
              <textarea className="input min-h-[80px]" value={editing.notes||""} onChange={e=>updateOffer({ id: editing.id, notes: e.target.value })} />
            </div>
            <div className="md:col-span-2 grid grid-cols-2 gap-3">
              <div className="p-3 rounded-xl bg-slate-50 border">
                <div className="text-xs text-gray-500">Sorgente PDF</div>
                <div className="font-medium">{editing.source}</div>
              </div>
              <div className="p-3 rounded-xl bg-slate-50 border">
                <div className="text-xs text-gray-500">Stima mensile</div>
                <div className="font-semibold">{fmtNumber(editing.estimated)} €</div>
              </div>
            </div>
            <div className="md:col-span-2 flex justify-between items-center">
              <button className="btn btn-danger" onClick={()=>{ deleteOffer(editing.id); setEditing(null); }}>Elimina offerta</button>
            </div>
          </div>
        )}
      </Modal>

      {/* Stili Tailwind di base per semplicità */}
      <style>{`
        .btn{ @apply inline-flex items-center px-3 py-2 rounded-xl border shadow-sm bg-white hover:bg-slate-50; }
        .btn-danger{ @apply border-red-200 text-red-700 bg-red-50 hover:bg-red-100; }
        .input{ @apply px-3 py-2 rounded-xl border bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-200; }
        .label{ @apply text-sm text-gray-600 mb-1 block; }
      `}</style>
    </div>
  );
}
