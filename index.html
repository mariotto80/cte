<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CTE Energia & Gas – Gestione Offerte Aziendali</title>
  <meta name="description" content="Carica e gestisci le offerte CTE Energia & Gas per aziende. Dashboard iniziale con sintesi offerte." />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .card{ background:#fff; border-radius:1rem; box-shadow:0 1px 3px rgba(0,0,0,.1), 0 1px 2px rgba(0,0,0,.06); padding:1.5rem; }
  </style>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2.47.10/dist/umd/supabase.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.7.76/pdf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
</head>
<body class="min-h-screen bg-slate-50">
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-sky-500 grid place-items-center text-white font-bold">CTE</div>
      <div class="flex-1">
        <h1 class="text-xl font-bold">CTE Energia & Gas</h1>
        <p class="text-sm text-slate-500">Gestione Offerte Aziendali</p>
      </div>
      <button id="btnSettings" class="px-3 py-2 text-sm rounded-lg border hover:bg-slate-100">Impostazioni</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- DASHBOARD RIASSUNTIVA -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-4">Dashboard – Sintesi Offerte</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <canvas id="offertePerFornitore"></canvas>
        </div>
        <div>
          <canvas id="offertePerScadenza"></canvas>
        </div>
        <div>
          <canvas id="totaleMensileOfferte"></canvas>
        </div>
      </div>
    </section>

    <!-- CARICAMENTO OFFERTE -->
    <section class="card">
      <h2 class="text-lg font-semibold mb-2">Carica Offerta (PDF/JPG/PNG)</h2>
      <p class="text-sm text-slate-600 mb-4">Carica le offerte aziendali per analisi e archiviazione centralizzata.</p>
      <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
        <input id="fileInput" type="file" accept="application/pdf,image/*" class="file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100" />
        <button id="btnProcess" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 disabled:opacity-50">Carica & Analizza</button>
        <div id="status" class="text-sm text-slate-600"></div>
      </div>
    </section>

    <!-- LISTA OFFERTE -->
    <section class="card">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Offerte Caricate</h2>
        <div class="flex gap-2">
          <input id="search" placeholder="Cerca azienda/fornitore" class="px-3 py-2 rounded-lg border w-64" />
          <button id="btnRefresh" class="px-3 py-2 rounded-lg border hover:bg-slate-100">Aggiorna</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100">
            <tr>
              <th class="px-3 py-2 text-left">Data Caricamento</th>
              <th class="px-3 py-2 text-left">Cliente</th>
              <th class="px-3 py-2 text-left">Fornitore</th>
              <th class="px-3 py-2 text-left">Importo €</th>
              <th class="px-3 py-2 text-left">Scadenza</th>
              <th class="px-3 py-2 text-left">POD/PDR</th>
              <th class="px-3 py-2 text-left">Azioni</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
  // Qui manteniamo la logica dei grafici ma rinominiamo i canvas
  function renderDashboard(items) {
    const groupBy = (arr, key) => arr.reduce((acc, cur) => { const k = cur[key] || 'N/D'; acc[k] = (acc[k] || []).concat(cur); return acc; }, {});

    const fornitori = groupBy(items, 'fornitore');
    const fornLabels = Object.keys(fornitori);
    const fornData = fornLabels.map(f => fornitori[f].length);
    new Chart(document.getElementById('offertePerFornitore'), { type: 'pie', data: { labels: fornLabels, datasets: [{ data: fornData }] } });

    const scadMap = {};
    items.forEach(i => { if (i.scadenza) scadMap[i.scadenza] = (scadMap[i.scadenza] || 0) + 1; });
    const scadLabels = Object.keys(scadMap);
    const scadData = scadLabels.map(l => scadMap[l]);
    new Chart(document.getElementById('offertePerScadenza'), { type: 'bar', data: { labels: scadLabels, datasets: [{ label: 'N. Offerte', data: scadData }] } });

    const monthMap = {};
    items.forEach(i => { const d = new Date(i.created_at); const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; monthMap[k] = (monthMap[k] || 0) + (i.importo || 0); });
    const monthLabels = Object.keys(monthMap);
    const monthData = monthLabels.map(l => monthMap[l]);
    new Chart(document.getElementById('totaleMensileOfferte'), { type: 'line', data: { labels: monthLabels, datasets: [{ label: 'Totale €', data: monthData }] } });
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const fakeItems = [];
    renderDashboard(fakeItems);
  });
  </script>
</body>
</html>
